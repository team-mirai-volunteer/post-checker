# DSL インポートコマンド設計

## 目的

チームみらいの開発者・CI/CD が、Git リポジトリで管理された DSL ファイルを Dify に反映できない状態を解消するため。

現状、`dify-cli export` で DSL をエクスポートできるが、逆方向の import がないため、以下のユースケースに対応できない：

1. **CI/CD でのデプロイ**: main ブランチにマージされた DSL の変更を、本番/ステージング環境の Dify に自動反映する
2. **開発環境のセットアップ**: 新しい開発者が `docker compose up` 後に、リポジトリの DSL を手動でインポートする手間を省く

## コマンド仕様

### 基本形式

```bash
dify-cli import [options]
```

### オプション

| オプション        | 短縮形 | 説明                                           | デフォルト         |
| ----------------- | ------ | ---------------------------------------------- | ------------------ |
| `--input-dir`     | `-i`   | DSL ファイルを読み込むディレクトリ             | `dify-settings/dsl` |
| `--force`         | `-f`   | 同名アプリが存在する場合、上書き更新する       | `false`            |
| `--dry-run`       |        | 実際にはインポートせず、実行内容を表示するのみ | `false`            |

### 環境変数

既存の export コマンドと同じ環境変数を使用：

| 変数名             | 必須 | 説明                         |
| ------------------ | ---- | ---------------------------- |
| `DIFY_CONSOLE_URL` | No   | Dify のベース URL（デフォルト: `http://localhost`） |
| `DIFY_EMAIL`       | No   | ログイン用メールアドレス     |
| `DIFY_PASSWORD`    | No   | ログイン用パスワード         |

## 処理フロー

```
1. 入力ディレクトリから *.yml ファイルを収集
2. Playwright で Console API の認証情報を取得
3. 既存アプリの一覧を取得
4. 各 DSL ファイルに対して:
   a. YAML をパースしてアプリ名を取得
   b. 同名アプリが存在するか確認
      - 存在しない → 新規作成
      - 存在する & --force なし → スキップ（警告出力）
      - 存在する & --force あり → 上書き更新
   c. 結果を記録
5. 結果サマリを出力
```

## 同名アプリの判定ロジック

DSL ファイル内の `app.name` フィールドと、Dify 上の既存アプリ名を**完全一致**で比較する。

```yaml
# DSL ファイル例
app:
  name: postchecker  # ← この値で判定
  mode: workflow
  ...
```

## API エンドポイント

Dify Console API のインポート用エンドポイントを使用：

### 新規作成

```
POST /console/api/apps/import
Content-Type: multipart/form-data

data: (YAML string)
```

### 上書き更新（--force 時）

既存アプリの DSL を更新する API を使用。具体的なエンドポイントは Dify のバージョンにより異なる可能性があるため、実装時に調査が必要。

候補：

- `POST /console/api/apps/{app_id}/import` （DSL で上書き）
- または新規作成後に既存アプリを削除する方式

## 出力形式

### 通常実行時

```
Importing DSLs to Dify...

  Created: postchecker.yml → postchecker (app_id: xxx)
  Skipped: other-app.yml (already exists, use --force to overwrite)

Import complete: 1 created, 1 skipped, 0 failed
```

### --force 使用時

```
Importing DSLs to Dify...

  Created: postchecker.yml → postchecker (app_id: xxx)
  Updated: other-app.yml → other-app (app_id: yyy)

Import complete: 1 created, 1 updated, 0 failed
```

### --dry-run 使用時

```
[DRY RUN] Importing DSLs to Dify...

  Would create: postchecker.yml → postchecker
  Would skip: other-app.yml (already exists)

Dry run complete: 1 would create, 1 would skip
```

## 終了コード

| コード | 意味                               |
| ------ | ---------------------------------- |
| 0      | 正常終了                           |
| 1      | 1 つ以上のインポートが失敗した     |

スキップは正常終了として扱う（終了コード 0）。

## ファイル構成

```
scripts/
├── dify-cli.ts                      # import コマンドを追加
└── src/
    ├── client/
    │   └── console.ts               # importDsl メソッドを追加
    └── usecase/
        └── import-dsl.ts            # 新規作成
```

## ConsoleClient への追加メソッド

```typescript
// console.ts に追加
async importDsl(yamlContent: string): Promise<{ app_id: string }>;
async updateAppDsl(appId: string, yamlContent: string): Promise<void>;
```

## インターフェース定義

```typescript
// import-dsl.ts

export interface ImportDslOptions {
  baseUrl: string;
  inputDir: string;
  email?: string;
  password?: string;
  force?: boolean;
  dryRun?: boolean;
  headless?: boolean;
}

export interface ImportResult {
  filename: string;
  appName: string;
  appId?: string;
  status: "created" | "updated" | "skipped" | "failed";
  error?: string;
}
```

## CI での使用例

```yaml
# .github/workflows/deploy-dsl.yml
name: Deploy DSL to Dify

on:
  push:
    branches: [main]
    paths:
      - "dify-settings/dsl/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Deploy DSL
        env:
          DIFY_CONSOLE_URL: ${{ secrets.DIFY_CONSOLE_URL }}
          DIFY_EMAIL: ${{ secrets.DIFY_EMAIL }}
          DIFY_PASSWORD: ${{ secrets.DIFY_PASSWORD }}
        run: npx tsx scripts/dify-cli.ts import --force
```

## 開発環境セットアップでの使用例

```bash
# 1. Dify を起動
docker compose up -d

# 2. 初期セットアップ（初回のみ）
npx tsx scripts/dify-cli.ts setup

# 3. DSL をインポート
npx tsx scripts/dify-cli.ts import --force
```

## エラーハンドリング

| エラー状況                       | 対応                                     |
| -------------------------------- | ---------------------------------------- |
| 入力ディレクトリが存在しない     | エラー終了                               |
| YAML パースエラー                | そのファイルを failed として続行         |
| アプリ名が取得できない           | そのファイルを failed として続行         |
| API エラー（認証失敗など）       | エラー終了                               |
| API エラー（個別インポート失敗） | そのファイルを failed として続行         |

## 備考

- Dify の import API の詳細仕様は、実装時に Dify のソースコードまたは API ドキュメントを確認する必要がある
- `--force` による上書き更新は、アプリの設定（環境変数、API キーなど）がリセットされる可能性があるため、注意書きをドキュメントに追記する
