# アーキテクチャ設計書

## 概要

本ドキュメントでは、post-checker（チームみらい発信チェッカー）のシステムアーキテクチャを定義する。

## システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         GitHub Repository                        │
│  ┌─────────────────┐    ┌─────────────────────────────────────┐ │
│  │  docs/          │    │  dify/                              │ │
│  │  └─ knowledge/  │    │  └─ workflows/  (DSLエクスポート)    │ │
│  │     └─ *.md     │    │                                     │ │
│  └────────┬────────┘    └─────────────────────────────────────┘ │
└───────────┼─────────────────────────────────────────────────────┘
            │
            │ GitHub Actions
            │ (push時に自動同期)
            ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Google Cloud Platform                     │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                      Cloud Run                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │  Dify API   │  │  Dify Web   │  │  Dify Worker        │ │ │
│  │  │  (Backend)  │  │  (Frontend) │  │  (Celery)           │ │ │
│  │  └──────┬──────┘  └─────────────┘  └──────────┬──────────┘ │ │
│  │         │                                      │            │ │
│  │         └──────────────┬───────────────────────┘            │ │
│  └────────────────────────┼────────────────────────────────────┘ │
│                           │                                      │
│  ┌────────────────────────┼────────────────────────────────────┐ │
│  │                        ▼                                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │ Cloud SQL   │  │ Cloud       │  │ Cloud Storage       │ │ │
│  │  │ (PostgreSQL)│  │ Memorystore │  │ (ファイル保存)       │ │ │
│  │  │             │  │ (Redis)     │  │                     │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  │                     マネージドサービス                       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Secret Manager (APIキー・認証情報)                         │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. GitHub Repository

本リポジトリで以下を一元管理する。

| ディレクトリ | 内容 |
|------------|------|
| `knowledge/` | RAG用ナレッジドキュメント（Markdown形式） |
| `dify/workflows/` | DifyワークフローのDSLエクスポート |
| `.github/workflows/` | CI/CDパイプライン定義 |
| `infra/` | Terraformによるインフラ定義（任意） |

### 2. Dify（Docker OSS版）

セルフホスティング版Difyを使用し、以下の機能を実現する。

- **RAGナレッジベース**: チームみらいの発信内容を格納
- **チェックワークフロー**: 並列処理による複数観点からのチェック
- **Web UI**: 利用者向けインターフェース

### 3. GCPインフラ

| サービス | 用途 | 備考 |
|---------|------|------|
| Cloud Run | Difyコンテナ実行 | API/Web/Workerの3サービス |
| Cloud SQL | PostgreSQL | Difyのメタデータ・ベクトルDB |
| Cloud Memorystore | Redis | セッション・キャッシュ・Celeryブローカー |
| Cloud Storage | ファイル保存 | アップロードファイル・ログ |
| Secret Manager | シークレット管理 | APIキー・DB接続情報 |

## データフロー

### ナレッジ同期フロー

```
1. knowledge/ 配下のMarkdownを更新
2. mainブランチへpush
3. GitHub Actions起動
4. Dify APIを呼び出してナレッジを更新
   - 既存ドキュメントの差分更新
   - 新規ドキュメントの追加
   - 削除されたドキュメントの削除
```

## セキュリティ

- Cloud Runは認証必須に設定（Identity-Aware Proxy または Firebase Auth）
- Secret ManagerでAPIキー・認証情報を管理
- VPCコネクタでCloud SQL・Memorystoreへのプライベート接続
- Cloud Armorによるアクセス制御（必要に応じて）

## ディレクトリ構成

```
post-checker-proto/
├── README.md
├── docs/                         # プロジェクトドキュメント
│   └── *.md
├── knowledges/                   # RAG用ナレッジドキュメント
│   └── <category>/              # カテゴリ別ディレクトリ
│       └── *.md
├── dify/
│   └── workflows/               # DifyワークフローDSL
│       └── *.yml
├── .github/
│   └── workflows/               # GitHub Actionsワークフロー
│       └── *.yml
└── infra/                       # インフラ定義（予定）
    ├── terraform/
    │   └── *.tf
    └── docker-compose.yml       # ローカル開発用
```
