# Dify E2E テスト基盤設計

## 目的

開発者がDify環境の疎通確認を自動化できるようにするため。

現状、Difyが正常に動作しているかの確認は手動でブラウザを開いて確認する必要がある。E2Eテストの雛形を用意することで、CI/CDパイプラインへの組み込みや、ローカル開発時の動作確認が容易になる。

## 設計概要

### テストディレクトリ構成

既存の `scripts/test/` を以下のように再構成する。

```
scripts/test/
├── unit/                    # 単体テスト（既存テストを移動）
│   ├── usecase/
│   │   ├── diff.test.ts
│   │   └── sync.test.ts
│   └── client/
│       └── knowledge.test.ts
├── integration/             # 統合テスト（実際のAPIを叩くテスト）
│   └── cli.test.ts          # 既存のCLIテストを移動
└── e2e/                     # E2Eテスト（Playwright）
    └── dify-health.spec.ts  # Dify Web UI 疎通確認
```

### テストフレームワーク

| テスト種別 | フレームワーク | 設定ファイル |
|-----------|---------------|-------------|
| unit | Vitest | vitest.config.ts |
| integration | Vitest | vitest.config.ts |
| e2e | Playwright Test | playwright.config.ts |

Playwright Testは `@playwright/test` パッケージを使用する。現在インストール済みの `playwright` パッケージとは別に追加が必要。

### E2Eテスト雛形（dify-health.spec.ts）

以下のシナリオで疎通確認を行う。

1. **Dify トップページ（ログインページ）へのアクセス**
   - URL: `${DIFY_CONSOLE_URL}/signin`
   - 期待: HTTP 200 でページが表示される

2. **ログイン後のダッシュボード確認（オプション）**
   - 環境変数でログイン情報が設定されている場合のみ実行
   - ログイン → `/apps` ページが HTTP 200 で表示される

### npm scripts 追加

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui"
  }
}
```

### Playwright 設定（playwright.config.ts）

```
- テストファイル: scripts/test/e2e/**/*.spec.ts
- ベースURL: 環境変数 DIFY_CONSOLE_URL から取得（デフォルト: http://localhost）
- ブラウザ: Chromium のみ（軽量化のため）
- ヘッドレス: CI環境では true、ローカルでは設定可能
- タイムアウト: 30秒
```

### 環境変数

既存の `.env.example` の変数をそのまま使用する。

| 変数名 | 用途 |
|--------|------|
| DIFY_CONSOLE_URL | Dify Console の URL（デフォルト: http://localhost） |
| DIFY_EMAIL | ログインテスト用メールアドレス（オプション） |
| DIFY_PASSWORD | ログインテスト用パスワード（オプション） |

### Vitest 設定の変更

E2Eテストは Playwright Test で実行するため、Vitest の対象から除外する。

```
include: ["scripts/test/unit/**/*.test.ts", "scripts/test/integration/**/*.test.ts"]
```

## 実装スコープ

今回の実装では以下を行う。

1. **ディレクトリ構成の変更**
   - `scripts/test/unit/` を作成し、既存テストを移動
   - `scripts/test/integration/` を作成
   - `scripts/test/e2e/` を作成

2. **Playwright Test のセットアップ**
   - `@playwright/test` パッケージの追加
   - `playwright.config.ts` の作成

3. **E2Eテスト雛形の作成**
   - `scripts/test/e2e/dify-health.spec.ts` を作成
   - Dify トップページへのアクセスで HTTP 200 を確認する最小限のテスト

4. **設定ファイルの更新**
   - `vitest.config.ts` のパス更新
   - `package.json` に E2E テスト用スクリプト追加

## 実装しないもの

- ログイン後のダッシュボード確認テスト（雛形完成後に追加可能）
- CI/CD への組み込み（別途設計）
- 複数ブラウザでのテスト
